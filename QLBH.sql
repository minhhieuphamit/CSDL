	CREATE DATABASE QLBH
ON(NAME='QLBH_DATA',FILENAME='H:\BAITAP\QLBH.MDF')
LOG ON(NAME='QLBH_LOG',FILENAME='H:\BAITAP\QLBH.LDF')
GO 
--
USE QLBH
GO
--
CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(5) PRIMARY KEY NOT NULL,
	TENKH NVARCHAR (30) NOT NULL,
	DIACHI NVARCHAR (50) NULL,
	DT VARCHAR (11) 
		CHECK( DT LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
			 OR DT LIKE'[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
			OR DT LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
			OR DT LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
			OR DT IS NULL),
	EMAIL VARCHAR (30)
)
GO
--
CREATE TABLE VATTU
(
	MAVT VARCHAR (5) PRIMARY KEY NOT NULL,
	TENVT NVARCHAR (30) NOT NULL,
	DVT NVARCHAR (20) NOT NULL,
	GIAMUA MONEY NULL CHECK(GIAMUA>0),
	SLTON INT NULL CHECK(SLTON>=0)
)
GO
--
CREATE TABLE HOADON
(
	MAHD VARCHAR (10) PRIMARY KEY NOT NULL,
	NGAY SMALLDATETIME NULL CHECK(NGAY<GETDATE()), 
	MAKH VARCHAR(5) NOT NULL,
	TONGTG FLOAT NULL
)
GO
--
CREATE TABLE CTHD
(
	MAHD VARCHAR (10) NOT NULL,
	MAVT VARCHAR (5) NOT NULL,
	SL INT  NULL CHECK(SL>0),
	KHUYENMAI FLOAT NULL,
	GIABAN FLOAT NULL
	PRIMARY KEY (MAHD,MAVT)
)
GO
--
ALTER TABLE HOADON
	ADD CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH) ON UPDATE CASCADE 
GO
--
ALTER TABLE CTHD
	ADD CONSTRAINT FK_CTHD_HOADON FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD) ON UPDATE CASCADE,
	    CONSTRAINT FK_CTHD_VATTU FOREIGN KEY (MAVT) REFERENCES VATTU(MAVT) ON UPDATE CASCADE
GO
--


INSERT VATTU VALUES (N'VT01', N'Xi măng', N'Bao', 50000.0000, 4870)
INSERT VATTU VALUES (N'VT02', N'Cát', N'Khối', 45000.0000, 49935)
INSERT VATTU VALUES (N'VT03', N'Gạch ống', N'Viên', 120.0000, 740000)
INSERT VATTU VALUES (N'VT04', N'Gạch thẻ', N'Viên', 110.0000, 750000)
INSERT VATTU VALUES (N'VT05', N'Đá lớn', N'Khối', 25000.0000, 99980)
INSERT VATTU VALUES (N'VT06', N'Đá nhỏ', N'Khối', 33000.0000, 99985)
INSERT VATTU VALUES (N'VT07', N'Lam gió', N'Cái', 15000.0000, 49980)
GO

INSERT INTO KHACHHANG VALUES (N'KH01', N'Nguyễn Thị Bé', N'Tân Bình', N'38457895', N'bnt@yahoo.com')
INSERT INTO KHACHHANG VALUES (N'KH02', N'Lê Hoàng Nam', N'Bình Chánh', N'39878987', N'namlehoang@gmail.com')
INSERT INTO KHACHHANG VALUES (N'KH03', N'Trần Thị Chiêu', N'Tân Bình', N'38457895', NULL)
INSERT INTO KHACHHANG VALUES (N'KH04', N'Mai Thị Quế Anh', N'Bình Chánh', NULL, NULL)
INSERT INTO KHACHHANG VALUES (N'KH05', N'Lê Văn Sáng', N'Quận 10', NULL, N'sanglv@hcm.vnn.vn')
INSERT INTO KHACHHANG VALUES (N'KH06', N'Trần Hoàng', N'Tân Bình', N'38457897', NULL)
GO

SET DATEFORMAT DMY
INSERT INTO HOADON VALUES (N'HD001', '12/5/2010', N'KH01', 560000)
INSERT INTO HOADON VALUES (N'HD002', '25/5/2010', N'KH02', 1500000)
INSERT INTO HOADON VALUES (N'HD003', '25/5/2010', N'KH01', 1100000)
INSERT INTO HOADON VALUES (N'HD004', '25/5/2010', N'KH04', 9900000)
INSERT INTO HOADON VALUES (N'HD005', '26/5/2010', N'KH04', 1165000)
INSERT INTO HOADON VALUES (N'HD006', '2/6/2010', N'KH03', 1200000)
INSERT INTO HOADON VALUES (N'HD007', '22/6/2010', N'KH04', 2500000)
INSERT INTO HOADON VALUES (N'HD008', '25/6/2010', N'KH03', 6440000)
INSERT INTO HOADON VALUES (N'HD009', '15/8/2010', N'KH04', 1200000)
INSERT INTO HOADON VALUES (N'HD010', '30/9/2010', N'KH01', 1425000)
GO

INSERT INTO CTHD VALUES (N'HD001', N'VT01', 5, NULL, 52000)
INSERT INTO CTHD VALUES (N'HD001', N'VT05', 10, NULL, 30000)
INSERT INTO CTHD VALUES (N'HD002', N'VT03', 10000, NULL, 150)
INSERT INTO CTHD VALUES (N'HD003', N'VT02', 20, NULL, 55000)
INSERT INTO CTHD VALUES (N'HD004', N'VT03', 50000, NULL, 150)
INSERT INTO CTHD VALUES (N'HD004', N'VT04', 20000, NULL, 120)
INSERT INTO CTHD VALUES (N'HD005', N'VT05', 10, NULL, 30000)
INSERT INTO CTHD VALUES (N'HD005', N'VT06', 15, NULL, 35000)
INSERT INTO CTHD VALUES (N'HD005', N'VT07', 20, NULL, 17000)
INSERT INTO CTHD VALUES (N'HD006', N'VT04', 10000, NULL, 120)
INSERT INTO CTHD VALUES (N'HD007', N'VT04', 20000, NULL, 125)
INSERT INTO CTHD VALUES (N'HD008', N'VT01', 100, NULL, 55000)
INSERT INTO CTHD VALUES (N'HD008', N'VT02', 20, NULL, 47000)
INSERT INTO CTHD VALUES (N'HD009', N'VT02', 25, NULL, 48000)
INSERT INTO CTHD VALUES (N'HD010', N'VT01', 25, NULL, 57000)
GO

--Tạo view
--Câu 1
CREATE VIEW view_Cau1
AS
	SELECT *
	FROM KHACHHANG
	WHERE DIACHI LIKE N'Tân Bình'
GO
SELECT * FROM view_Cau1
GO

--Câu 2
CREATE VIEW view_Cau2
AS
	SELECT *
	FROM KHACHHANG
	WHERE DT IS NULL
GO
SELECT * FROM view_Cau2
GO

--Câu 3
CREATE VIEW view_Cau3
AS
	SELECT *
	FROM KHACHHANG
	WHERE DT IS NULL AND EMAIL IS NULL
GO
SELECT * FROM view_Cau3
GO

--Câu 4
CREATE VIEW view_Cau4
AS
	SELECT *
	FROM KHACHHANG
	WHERE DT IS NOT NULL AND EMAIL IS NOT NULL
GO
SELECT * FROM view_Cau4
GO

--Câu 5
CREATE VIEW view_Cau5
AS
	SELECT *
	FROM VATTU
	WHERE DVT LIKE N'Cái'
GO
SELECT * FROM view_Cau5
GO

--Câu 6
CREATE VIEW view_Cau6
AS
	SELECT *
	FROM VATTU
	WHERE GIAMUA > 25000
GO
SELECT * FROM view_Cau6
GO

--Câu 7 
CREATE VIEW view_Cau7
AS
	SELECT *
	FROM VATTU
	WHERE TENVT LIKE N'Gạch%'
GO
SELECT * FROM view_Cau7
GO

--Câu 8
CREATE VIEW view_Cau8
AS
	SELECT *
	FROM VATTU
	WHERE GIAMUA > 20000 AND GIAMUA < 40000 
GO
SELECT * FROM view_Cau8
GO

--Câu 9
CREATE VIEW view_Cau9
AS
	SELECT HD.MAHD, CONVERT(VARCHAR(11),HD.NGAY,103) [NGAY LAP HOA DON], TENKH, DIACHI, DT
	FROM HOADON HD, KHACHHANG KH
	WHERE HD.MAKH = KH.MAKH
GO
SELECT * FROM view_Cau9
GO

--Câu 10
CREATE VIEW view_Cau10
AS
	SELECT HD.MAHD, CONVERT(VARCHAR(11),HD.NGAY,103) [NGAY LAP HOA DON], TENKH, DIACHI, DT
	FROM HOADON HD, KHACHHANG KH
	WHERE HD.MAKH = KH.MAKH AND NGAY = '25/5/2010'
GO
SELECT * FROM view_Cau10
GO

--Câu 11
CREATE VIEW view_Cau11
AS
	SELECT HD.MAHD, CONVERT(VARCHAR(11),HD.NGAY,103) [NGAY LAP HOA DON], TENKH, DIACHI, DT
	FROM HOADON HD, KHACHHANG KH
	WHERE HD.MAKH = KH.MAKH AND MONTH(NGAY) = MONTH('1/6/2010')
GO
SELECT * FROM view_Cau11
GO

--Câu 12
CREATE VIEW view_Cau12
AS
	SELECT DISTINCT TENKH, DIACHI, DT
	FROM HOADON HD, KHACHHANG KH
	WHERE HD.MAKH = KH.MAKH AND MONTH(NGAY) = MONTH('1/6/2010')
GO
SELECT * FROM view_Cau12
GO

--Câu 13
CREATE VIEW view_Cau13
AS
	SELECT DISTINCT TENKH, DIACHI, DT
	FROM HOADON HD, KHACHHANG KH
	EXCEPT
	SELECT DISTINCT TENKH, DIACHI, DT
	FROM HOADON HD, KHACHHANG KH
	WHERE HD.MAKH = KH.MAKH AND MONTH(NGAY) = MONTH('1/6/2010')
GO
SELECT * FROM view_Cau13
GO

--Câu 14
CREATE VIEW view_Cau14
AS
	SELECT MAHD, CT.MAVT, VT.TENVT, DVT, GIABAN, GIAMUA, SL, GIAMUA * SL [TRI GIA MUA], GIABAN * SL [TRI GIA BAN]
	FROM CTHD CT, VATTU VT
	WHERE CT.MAVT = VT.MAVT
GO
SELECT * FROM view_Cau14
GO

--Câu 15
CREATE VIEW view_Cau15
AS
	SELECT MAHD, CT.MAVT, VT.TENVT, DVT, GIABAN, GIAMUA, SL, GIAMUA * SL [TRI GIA MUA], GIABAN * SL [TRI GIA BAN]
	FROM CTHD CT, VATTU VT
	WHERE CT.MAVT = VT.MAVT AND GIABAN >= GIAMUA
GO
SELECT * FROM view_Cau15
GO

--Câu 16
CREATE VIEW view_Cau16
AS
	SELECT MAHD, CT.MAVT, VT.TENVT, DVT, GIABAN, GIAMUA, SL, GIAMUA * SL [TRI GIA MUA], GIABAN * SL [TRI GIA BAN], (CASE WHEN SL > 100 THEN GIABAN * SL * 0.1 ELSE 0 END) [KHUYEN MAI]					
	FROM CTHD CT, VATTU VT
	WHERE CT.MAVT = VT.MAVT 
GO
SELECT * FROM view_Cau16
GO 

--Câu 17
CREATE VIEW view_Cau17
AS
	SELECT CT.MAVT, TENVT, SL
	FROM CTHD CT, VATTU VT
	WHERE CT.MAVT = VT.MAVT AND SL = 0
	GROUP BY CT.MAVT, TENVT, SL
GO
SELECT * FROM view_Cau17
GO

--Câu 18
CREATE VIEW view_Cau18
AS
	SELECT CT.MAHD,  CONVERT(VARCHAR(11),NGAY,103) [NGAY], TENKH, DIACHI, DT, TENVT, DVT, GIAMUA, GIABAN, SL, GIAMUA * SL [TRI GIA MUA], GIABAN * SL [TRI GIA BAN]
	FROM KHACHHANG KH, CTHD CT, HOADON HD, VATTU VT
	WHERE KH.MAKH = HD.MAKH AND HD.MAHD = CT.MAHD AND CT.MAVT = VT.MAVT 
GO
SELECT * FROM view_Cau18
GO

--Câu 19
CREATE VIEW view_Cau19
AS
	SELECT CT.MAHD,  CONVERT(VARCHAR(11),NGAY,103) [NGAY], TENKH, DIACHI, DT, TENVT, DVT, GIAMUA, GIABAN, SL, GIAMUA * SL [TRI GIA MUA], GIABAN * SL [TRI GIA BAN]
	FROM KHACHHANG KH, CTHD CT, HOADON HD, VATTU VT
	WHERE KH.MAKH = HD.MAKH AND HD.MAHD = CT.MAHD AND CT.MAVT = VT.MAVT AND MONTH(NGAY) = 5
GO
SELECT * FROM view_Cau19
GO

--Câu 20 
CREATE VIEW view_Cau20
AS
	SELECT CT.MAHD, CONVERT(VARCHAR(11),NGAY,103) [NGAY], TENKH, DIACHI, DT, TENVT, DVT, GIAMUA, GIABAN, SL, GIAMUA * SL [TRI GIA MUA], GIABAN * SL [TRI GIA BAN], DATEPART(QUARTER, NGAY) [QUY]
	FROM KHACHHANG KH, CTHD CT, HOADON HD, VATTU VT
	WHERE KH.MAKH = HD.MAKH AND HD.MAHD = CT.MAHD AND CT.MAVT = VT.MAVT AND DATEPART(QUARTER, NGAY) = 1
GO
SELECT * FROM view_Cau20
GO

--Câu 21
CREATE VIEW view_Cau21
AS
	SELECT HD.MAHD, CONVERT(VARCHAR(11),HD.NGAY,103) [NGAY], TENKH, DIACHI, TONGTG
	FROM HOADON HD, KHACHHANG KH
	WHERE KH.MAKH = HD.MAKH
GO
SELECT * FROM view_Cau21
GO

CREATE VIEW view_Cau22
AS
	SELECT TOP 1 HD.MAHD, CONVERT(VARCHAR(11),HD.NGAY,103) [NGAY], TENKH, DIACHI, TONGTG
	FROM HOADON HD, KHACHHANG KH
	WHERE KH.MAKH = HD.MAKH
	ORDER BY TONGTG DESC
GO
SELECT * FROM view_Cau22
GO 

--Câu 23
CREATE VIEW view_Cau23
AS
	SELECT TOP 1 HD.MAHD, CONVERT(VARCHAR(11),HD.NGAY,103) [NGAY], TENKH, DIACHI, TONGTG
	FROM HOADON HD, KHACHHANG KH
	WHERE KH.MAKH = HD.MAKH AND MONTH(NGAY) = 5
	ORDER BY TONGTG DESC
GO
SELECT * FROM view_Cau23
GO

--Câu 24
CREATE VIEW view_Cau24
AS
	SELECT TENKH, DIACHI, SUM(TONGTG) [TONGTG], COUNT(MAHD)[SO LUONG HOA DON]
	FROM HOADON HD, KHACHHANG KH
	WHERE KH.MAKH = HD.MAKH
	GROUP BY TENKH, DIACHI
GO
SELECT * FROM view_Cau24
GO

--Câu 25
CREATE VIEW view_Cau25
AS
	SELECT TENKH, DIACHI, MONTH(HD.NGAY) [THANG], COUNT(MAHD)[SO LUONG HOA DON]
	FROM HOADON HD, KHACHHANG KH
	WHERE KH.MAKH = HD.MAKH
	GROUP BY TENKH, DIACHI, HD.NGAY
GO
SELECT * FROM view_Cau25
GO

--Tạo procedure
--Câu 1
CREATE PROC BAI_1 @NGAY_MUA SMALLDATETIME 
AS
	SELECT K. *, CONVERT(VARCHAR(11),NGAY,103) AS [NGÀY]
	FROM HOADON H, KHACHHANG K
	WHERE K.MAKH=H.MAKH AND NGAY = @NGAY_MUA
GO		
SET DATEFORMAT DMY
EXEC BAI_1 '25/5/2010'
GO

--Câu 2
CREATE PROC BAI_2 @X INT
AS	
	SELECT K. *,SUM(SL*GIABAN) AS [Tổng trị giá]
	FROM KHACHHANG K, HOADON H, CTHD C
	WHERE K.MAKH=H.MAKH AND H.MAHD=C.MAHD
	GROUP BY K.MAKH, TENKH, DIACHI, DT, EMAIL
	HAVING SUM(SL*GIABAN) > @X
GO
EXEC BAI_2 1000
GO

--Câu 3
CREATE PROC BAI_3 @X INT
AS	
	SELECT TOP (@X) K.MAKH, TENKH, [Tong tri gia]=SUM(SL*GIABAN) 
	FROM KHACHHANG K, HOADON H, CTHD C
	WHERE K.MAKH = H.MAKH AND H.MAHD = C.MAHD
	GROUP BY K.MAKH, TENKH
	ORDER BY SUM(SL*GIABAN) DESC
GO
EXEC BAI_3 3
GO

--Câu 4
CREATE PROC BAI_4 @X INT
AS
	SELECT TOP (@X) V.MAVT, TENVT,  [So luong ban] = SUM(SL)
	FROM VATTU V, CTHD C
	WHERE V.MAVT = C.MAVT
	GROUP BY V.MAVT, TENVT
	ORDER BY SUM(SL) DESC
GO
EXEC BAI_4 3
GO

--Câu 5
CREATE PROC BAI_5 @X INT 
AS 
	SELECT TOP (@X) V.MAVT, TENVT, [San pham lai]=SUM(SL*GIABAN)-SUM(SL*GIAMUA)
	FROM VATTU V, CTHD C
	WHERE V.MAVT = C.MAVT
	GROUP BY V.MAVT, TENVT
	ORDER BY SUM(SL) ASC
GO
EXEC BAI_5 3
GO

--Câu 6
CREATE PROC BAI_6 @X INT
AS
	SELECT TOP (@X) MAHD, CONVERT(VARCHAR(11),NGAY,103) [NGAY], MAKH, TONGTG
	FROM HOADON
	ORDER BY TONGTG DESC
GO
EXEC BAI_6 3
GO

--Câu 7
CREATE PROC BAI_7
AS
	UPDATE CTHD SET KHUYENMAI = 0.05 WHERE SL > 100 AND SL <= 500
	UPDATE CTHD SET KHUYENMAI = 0.1 WHERE SL > 500
	UPDATE CTHD SET KHUYENMAI = 0 WHERE SL < 100
GO
EXEC BAI_7
SELECT * FROM CTHD
GO

--Câu 8
CREATE PROC BAI_8
AS
	UPDATE VATTU SET SLTON = SLTON - (SELECT SUM(SL)
						FROM CTHD C, VATTU VT
						WHERE VT.MAVT = C.MAVT
						GROUP BY C.MAVT)
GO
EXEC BAI_8
SELECT * FROM VATTU
GO

--Tạo funtion
--Câu 1
CREATE FUNCTION function_Cau1 (@NAM INT)
RETURNS FLOAT
AS
BEGIN
	DECLARE @TDT FLOAT
	SELECT @TDT = SUM(TONGTG)
	FROM HOADON HD
	WHERE YEAR(NGAY) = @NAM
	RETURN @TDT
END	
GO
SELECT dbo.function_Cau1 (2010) [TONG DOANH THU]
GO

--Câu 2
CREATE FUNCTION function_Cau2 (@NAM INT, @THANG INT)
RETURNS FLOAT
AS
BEGIN
	DECLARE @TDT FLOAT
	SELECT @TDT = SUM(TONGTG)
	FROM HOADON 
	WHERE YEAR(NGAY) = @NAM AND MONTH(NGAY) = @THANG
	RETURN @TDT
END
GO
SELECT dbo.function_Cau2 (2010, 12) [TONG DOANH THU]
GO

--Câu 3
CREATE FUNCTION function_Cau3 (@MAKH VARCHAR(5))
RETURNS FLOAT
AS
BEGIN
	DECLARE @TDT FLOAT
	SELECT @TDT = SUM(TONGTG)
	FROM HOADON 
	WHERE MAKH LIKE @MAKH
	RETURN @TDT
END
GO
SELECT dbo.function_Cau3 ('KH01') [TONG DOANH THU]
GO

--Câu 4

--Tạo trigger
--Câu 1
CREATE TRIGGER trig_Cau1 ON KHACHHANG 
FOR DELETE 
AS
BEGIN
	DECLARE @MAKH NVARCHAR(5)
	SELECT @MAKH = MAKH 
	FROM DELETED 

	IF EXISTS (SELECT * FROM HOADON WHERE MAKH = @MAKH)
    BEGIN
        RAISERROR(N'KHONG XOA DUOC KHACH HANG NAY',16,1)
        ROLLBACK TRANSACTION
	END
END

DELETE FROM KHACHHANG WHERE MAKH LIKE 'KH01'
GO

--Câu 2
CREATE TRIGGER trig_Cau2 ON HOADON
FOR DELETE
AS
BEGIN
	IF EXISTS (
					SELECT D.MAHD
					FROM CTHD CT, deleted D
					WHERE CT.MAHD = D.MAHD
				)
	BEGIN 
		RAISERROR(N'KHONG XOA DUOC', 16, 1)
		ROLLBACK TRANSACTION
	END
END

DELETE FROM HOADON WHERE MAHD = 'HD001'
GO

--Câu 3
CREATE TRIGGER trig_Cau3
ON VATTU
FOR INSERT
AS
BEGIN 
	DECLARE @TENVT NVARCHAR(30)
	SELECT @TENVT = TENVT
	FROM inserted

	IF EXISTS (SELECT * FROM VATTU WHERE TENVT LIKE @TENVT)
	BEGIN
		RAISERROR(N'ĐÃ TỒN TẠI TÊN VẬT TƯ',16,1)
        ROLLBACK TRANSACTION
	END
END

INSERT INTO VATTU VALUES (N'ABC', N'Xi măng', N'Bao', 50000.0000, 4870)
GO		

--Câu 4
CREATE TRIGGER trig_Cau4 ON CTHD
FOR UPDATE
AS
	UPDATE CTHD
	SET KHUYENMAI = CASE WHEN SL > 100 AND SL <= 500 THEN 0.05
						 WHEN SL > 500 THEN 0.1
END
GO

--Câu 10
CREATE TRIGGER trig_Cau10 ON CTHD
FOR INSERT 
AS
	IF NOT EXISTS(
					SELECT *
					FROM VATTU VT, inserted I
					WHERE VT.MAVT = I.MAVT AND VT.TENVT LIKE N'%Gạch' AND (I.SL % 100) = 0
				)
	BEGIN 
		RAISERROR('')