/*
Họ và tên: Phạm Minh Hiếu
MSSV: 2011063873
Lớp: 20DTHB4
*/

-- Tạo database 
CREATE DATABASE QLSV
ON
	(NAME='QLSV_DATA',
	FILENAME='H:\BAITAP\QLSV.MDF')
LOG ON
	(NAME='QLSV_LOG',
	FILENAME='H:\BAITAP\QLSV.LDF')
GO

USE QLSV
GO

--Tạo bảng lớp
CREATE TABLE LOP
(
	MALOP CHAR(7),
	TENLOP NVARCHAR(50),
	SISO TINYINT CHECK(SISO > 0),

	CONSTRAINT PK_LOP_MALOP PRIMARY KEY(MALOP)
)
GO

--Tạo bảng môn học
CREATE TABLE MONHOC
(
	MAMH CHAR(6),
	TENMH NVARCHAR(50),
	TCLT TINYINT CHECK(TCLT > 0),
	TCTH TINYINT CHECK(TCTH >=0),

	CONSTRAINT PK_MONHOC_MAMH PRIMARY KEY(MAMH)
)

--Tạo bảng sinh viên
CREATE TABLE SINHVIEN
(
	MSSV CHAR(6),
	HOTEN NVARCHAR(50),
	NTNS DATE,
	PHAI BIT CHECK(PHAI IN(1,0)),
	MALOP CHAR(7),

	CONSTRAINT PK_SINHVIEN_MSSV PRIMARY KEY(MSSV),

	CONSTRAINT FK_SINHVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
	ON UPDATE CASCADE
	ON DELETE CASCADE,
)
GO

--Tạo bảng điểm sinh viên
CREATE TABLE DIEMSV
(
	MSSV CHAR(6),
	MAMH CHAR(6),
	DIEM DECIMAL(3,1) CHECK(DIEM BETWEEN 0 AND 10)

	CONSTRAINT PK_DIEMSV PRIMARY KEY(MSSV,MAMH) 

	CONSTRAINT FK_DIEMSV_MSSV FOREIGN KEY(MSSV) REFERENCES SINHVIEN(MSSV)
	ON UPDATE CASCADE
	ON DELETE CASCADE,

	CONSTRAINT FK_DIEMSV_MAMH FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
	ON UPDATE CASCADE
	ON DELETE CASCADE
)
GO

--Thêm dữ liệu bảng lớp
INSERT INTO LOP VALUES ('18DTH01',N'CNTT Khóa 18, Lớp 1','50')
INSERT INTO LOP VALUES ('18DTH02',N'CNTT Khóa 18, Lớp 2','45')
INSERT INTO LOP VALUES ('19DTH01',N'CNTT Khóa 19, Lớp 1','55')
INSERT INTO LOP VALUES ('19DTH02',N'CNTT Khóa 18, Lớp 2','50')
INSERT INTO LOP VALUES ('19DTH03',N'CNTT Khóa 18, Lớp 3','10')
GO

--Thêm dữ liệu bảng môn học
INSERT INTO MONHOC VALUES ('COS201',N'Kỹ thuật lập trình','2','1')
INSERT INTO MONHOC VALUES ('COS202',N'Lý thuyết đồ thị','2','1')
INSERT INTO MONHOC VALUES ('COS203',N'CSDL và quản trị CSDL','3','0')
INSERT INTO MONHOC VALUES ('COS204',N'Phân tích thiết kế hệ thống','3','0')
INSERT INTO MONHOC VALUES ('COS205',N'CSDL phân tán','3','0')
GO

--Thêm dữ liệu bảng sinh viên
SET DATEFORMAT DMY
INSERT INTO SINHVIEN VALUES ('170001',N'Lê Hoài An','12/10/1999','0','18DTH01')
INSERT INTO SINHVIEN VALUES ('180002',N'Nguyễn Thị Hòa Bình','20/11/2000','0','18DTH01')
INSERT INTO SINHVIEN VALUES ('180003',N'Phạm Tường Châu','07/06/2000','1','18DTH02')
INSERT INTO SINHVIEN VALUES ('180004',N'Trần Công Danh','31/01/2000','1','19DTH01')
GO

--Thêm dữ liệu bảng điểm
INSERT INTO DIEMSV VALUES ('170001','COS201','10')
INSERT INTO DIEMSV VALUES ('170001','COS202','10')
INSERT INTO DIEMSV VALUES ('170001','COS203','10')
INSERT INTO DIEMSV VALUES ('170001','COS204','10')
INSERT INTO DIEMSV VALUES ('170001','COS205','10')
INSERT INTO DIEMSV VALUES ('180002','COS201','3.5')
INSERT INTO DIEMSV VALUES ('180002','COS202','7')
INSERT INTO DIEMSV VALUES ('180003','COS201','8.5')
INSERT INTO DIEMSV VALUES ('180003','COS202','2')
INSERT INTO DIEMSV VALUES ('180003','COS203','6.5')
INSERT INTO DIEMSV VALUES ('180004','COS201','8')
INSERT INTO DIEMSV VALUES ('180004','COS204',NULL)
GO


--Câu 1
INSERT INTO SINHVIEN VALUES ('190001',N'Đào Thị Tuyết Hoa','08/03/2001','0','19DTH02')
GO

--Câu 2
UPDATE MONHOC SET TENMH = N'Toán rời rạc'
WHERE TENMH LIKE N'Lý thuyết đồ thị'
SELECT * FROM MONHOC
GO

--Câu 3
SELECT TENMH [Tên môn học]
FROM MONHOC
WHERE TCTH = '0'
GO

--Câu 4
SELECT TENMH [Tên môn học], TCLT, TCTH
FROM MONHOC
WHERE TCTH > 0
GO

--Câu 5
SELECT TENMH [Tên môn học]
FROM MONHOC
WHERE TENMH LIKE 'C%'
GO

--Câu 6
SELECT MSSV, HOTEN [Họ và tên], CONVERT(VARCHAR(11),NTNS,103) [Ngày sinh], PHAI[Giới tính], MALOP [Mã lớp]
FROM SINHVIEN
WHERE HOTEN LIKE N'%Thị%' 
GO

--Câu 7
SELECT TOP 2 WITH TIES MALOP[Mã lớp], TENLOP[Tên lớp], SISO[Sĩ số]
FROM LOP
ORDER BY SISO DESC
GO

--Câu 8
SELECT MSSV, HOTEN[Họ và tên], CONVERT(VARCHAR(11),NTNS,103) [Ngày sinh], PHAI[Giới tính], MALOP [Mã lớp]
FROM SINHVIEN
ORDER BY MALOP DESC
GO

--Câu 9
SELECT MSSV, HOTEN[Họ và tên], YEAR(GETDATE()) - YEAR(NTNS) [Tuổi]
FROM SINHVIEN
WHERE YEAR(GETDATE()) - YEAR(NTNS) >= 20
GO

--Câu 10
SELECT MH.MAMH [Mã môn học], TENMH[Môn học]
FROM MONHOC MH, DIEMSV D
WHERE MH.MAMH = D.MAMH AND DIEM IS NULL
GO

--Câu 11
SELECT SV.MSSV, SV.HOTEN [Họ và tên], SV.MALOP [Mã lớp], MH.TENMH [Môn học],DIEM [Điểm]
FROM SINHVIEN SV, DIEMSV D, MONHOC MH
WHERE SV.MSSV = D.MSSV AND D.MAMH = MH.MAMH AND SV.MSSV = '170001'

--Câu 12
SELECT SV.HOTEN [Họ và tên], D.MAMH [Mã môn học]
FROM SINHVIEN SV, DIEMSV D
WHERE SV.MSSV = D.MSSV AND D.DIEM > 7

--Câu 13
SELECT MH.TENMH [Môn học], COUNT(D.DIEM) [Số lượng]
FROM MONHOC MH, DIEMSV D
WHERE MH.MAMH = D.MAMH 
GROUP BY TENMH
GO

--Câu 14
SELECT SV.HOTEN [Họ và tên], AVG(D.DIEM) [Điểm trung bình]
FROM SINHVIEN SV, DIEMSV D
WHERE SV.MSSV = D.MSSV
GROUP BY SV.HOTEN
GO

--Câu 15
SELECT TOP 1 HOTEN [Họ và tên], D.DIEM [Điểm]
FROM SINHVIEN SV, DIEMSV D, MONHOC MH
WHERE SV.MSSV = D.MSSV AND D.MAMH = MH.MAMH AND MH.TENMH LIKE N'%Kỹ thuật lập trình%'
GROUP BY SV.HOTEN, D.DIEM
ORDER BY D.DIEM DESC
GO

--Câu 16
SELECT TOP 1 SV.HOTEN [Họ và tên], AVG(D.DIEM) [Điểm trung bình]
FROM SINHVIEN SV, DIEMSV D
WHERE SV.MSSV = D.MSSV
GROUP BY SV.HOTEN
ORDER BY AVG(D.DIEM) DESC
GO

--Câu 17
SELECT SV.HOTEN [Họ và tên]
FROM SINHVIEN SV , DIEMSV D, MONHOC MH
WHERE SV.MSSV = D.MSSV  AND MH.MAMH = D.MAMH AND SV.HOTEN NOT IN 
	(
	SELECT SV.HOTEN
	FROM SINHVIEN SV , MONHOC MH, DIEMSV D
	WHERE SV.MSSV = D.MSSV AND D.MAMH = MH.MAMH AND MH.MAMH = 'COS202'
	GROUP BY SV.HOTEN
	)
GROUP BY SV.HOTEN
GO

--Câu 18
SELECT HOTEN [Họ và tên], CONVERT(VARCHAR(11),NTNS,103) [Ngày sinh]
FROM SINHVIEN
WHERE 
GO

--Câu 19
SELECT COUNT(MSSV) [Tổng số sinh viên], COUNT(PHAI) [Tổng sinh viên nữ]
FROM SINHVIEN
WHERE PHAI = 0

--Câu 20
SELECT SV.MSSV, HOTEN [Họ và tên]
FROM SINHVIEN SV, DIEMSV D
WHERE SV.MSSV = D.MSSV AND D.DIEM < '5'



SELECT HOTEN [Họ và tên], D.DIEM [Điểm], l.MALOP [Mã lớp]
FROM SINHVIEN SV, DIEMSV D, MONHOC MH, LOP L
WHERE SV.MSSV = D.MSSV AND D.MAMH = MH.MAMH AND SV.MALOP = L.MALOP AND MH.TENMH LIKE N'%Kỹ thuật lập trình%'
GROUP BY SV.HOTEN, D.DIEM, L.MALOP
ORDER BY D.DIEM DESC
GO

--Câu 29
DELETE
FROM SINHVIEN
WHERE NOT EXISTS 
	(	
	SELECT MSSV
	FROM DIEMSV
	WHERE MSSV=SINHVIEN.MSSV
    )
GO
