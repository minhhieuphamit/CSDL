CREATE DATABASE HTQLGPLX
ON
	(NAME='HTQL_DATA',
	FILENAME='H:\BAITAP\HTQL.MDF')
LOG ON
	(NAME='HTQL_LOG',
	FILENAME='H:\BAITAP\HTQL.LDF')

USE HTQLGPLX
GO

--Tạo bảng thông tin tỉnh
CREATE TABLE TINH
(
	MATINH NCHAR(02) PRIMARY KEY,
	TENTINH NVARCHAR(16)NOT NULL,
)
GO

--Tạo bảng thông tin huyện
CREATE TABLE HUYEN
(
	MATINH NCHAR(02)NOT NULL,
	MAHUYEN NCHAR(02)PRIMARY KEY,
	TENHUYEN NVARCHAR(20)NOT NULL,

	CONSTRAINT FK_HUYEN_MATINH FOREIGN KEY(MATINH) REFERENCES dbo.TINH(MATINH) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,
)
GO

--Tạo bảng thông tin dân tộc
CREATE TABLE DANTOC
(
	MADT NCHAR(02)PRIMARY KEY,
	TENDT NVARCHAR(20)NOT NULL,
)
GO

--Tạo bảng thông tin tôn giáo
CREATE TABLE TONGIAO
(
	MATG NCHAR(02)PRIMARY KEY,
	TENTG NVARCHAR(50)NOT NULL,
)
GO

--Tạo bảng thông tin hạng gplx
CREATE TABLE HANGGPLX
(
	MAHANG NCHAR(02)PRIMARY KEY,
	LOAIXE NVARCHAR(100)NOT NULL,
)
GO

--Tạo bảng thông tin cơ sở đào tạo
CREATE TABLE CSDAOTAO
(
	MACSDT NCHAR(02)PRIMARY KEY,
	TENCSDT NVARCHAR(50)NOT NULL,
)
GO

--Tạo bảng thông tin lý lịch
CREATE TABLE LYLICH
(
	SOLYLICH NCHAR(10)PRIMARY KEY,
	HOLOT NVARCHAR(30)NOT NULL,
	TEN NVARCHAR(07)NOT NULL,
	NGAYSINH DATE NOT NULL,
	GIOITINH NVARCHAR(5) CHECK(GIOITINH IN(N'Nam',N'Nữ')),
	CMND CHAR(12)NOT NULL UNIQUE,
	MATINH NCHAR(02)NOT NULL,
	DIACHITT NVARCHAR(50)NOT NULL,
	MAHUYEN NCHAR(02)NOT NULL,
	SDT NCHAR(12)UNIQUE,
	MADT NCHAR(02)NOT NULL,
	MATG NCHAR(02)NOT NULL,
	QUOCTICH NVARCHAR(20)NOT NULL,
	GHICHU NVARCHAR(100),

	CONSTRAINT FK_LYLICH_DANTOC FOREIGN KEY(MADT) REFERENCES dbo.DANTOC(MADT) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,

	CONSTRAINT FK_LYLICH_MATG FOREIGN KEY(MATG) REFERENCES dbo.TONGIAO(MATG) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,

	CONSTRAINT FK_LYLICH_TINH FOREIGN KEY(MATINH) REFERENCES dbo.TINH(MATINH) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,

	CONSTRAINT FK_LYLICH_HUYEN FOREIGN KEY(MAHUYEN) REFERENCES dbo.HUYEN(MAHUYEN) 
	ON DELETE NO ACTION 
	ON UPDATE NO ACTION
)
GO

--Tạo bảng thông tin hồ sơ gplx 
CREATE TABLE HOSOGPLX
(
	SERIAL NCHAR(12)PRIMARY KEY,
	SOLYLICH NCHAR(10)NOT NULL,
	NGAYCAP DATE NOT NULL,
	THOIHAN DATE NOT NULL,
	MAHANG NCHAR(02)NOT NULL,
	MACSDT NCHAR(02)NOT NULL,
	DIEMLT INT NOT NULL,
	DIEMTH INT NOT NULL,

	CONSTRAINT FK_HOSOGPLX_SOLYLICH FOREIGN KEY(SOLYLICH) REFERENCES dbo.LYLICH(SOLYLICH) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,

	CONSTRAINT FK_HOSOGPLX_MAHANG FOREIGN KEY(MAHANG) REFERENCES dbo.HANGGPLX(MAHANG) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,

	CONSTRAINT FK_HOSOGPLX_MACSDT FOREIGN KEY(MACSDT) REFERENCES dbo.CSDAOTAO(MACSDT) 
	ON UPDATE CASCADE
	ON DELETE CASCADE,
)
GO

--Tạo bảng tạm giữ gplx
CREATE TABLE TAMGIUGPLX
(
	SOTHUTU NCHAR(10)PRIMARY KEY,
	SERIAL NCHAR(12)NOT NULL,
	LIDO NVARCHAR(100)NOT NULL,
	THOIGIANTHU DATE NOT NULL,
	THOIGIANTRA DATE NOT NULL,
	GHICHU NVARCHAR(100),

	CONSTRAINT FK_TAMGIUGPLX_SERIAL FOREIGN KEY(SERIAL) REFERENCES dbo.HOSOGPLX(SERIAL) 
	ON DELETE NO ACTION 
	ON UPDATE NO ACTION,
)
GO 

--Dữ liệu mã tỉnh 
INSERT INTO TINH VALUES('1',N'Hà Nội')
INSERT INTO TINH VALUES('2',N'Hồ Chí Minh')
INSERT INTO TINH VALUES('3',N'Đà Nẵng')
GO

--Dữ liệu mã huyện
INSERT INTO HUYEN VALUES('1','1',N'Quận Ba Đình')
INSERT INTO HUYEN VALUES('1','2',N'Quận Hoàn Kiếm')
INSERT INTO HUYEN VALUES('1','3',N'Quận Hai Bà Trưng')
INSERT INTO HUYEN VALUES('1','4',N'Quận Đống Đa')
INSERT INTO HUYEN VALUES('1','5',N'Quận Tây Hồ')
INSERT INTO HUYEN VALUES('1','6',N'Quận Cầu Giấy')
INSERT INTO HUYEN VALUES('1','7',N'Quận Thanh Xuân')
INSERT INTO HUYEN VALUES('1','8',N'Quận Hoàng Mai')
INSERT INTO HUYEN VALUES('1','9',N'Quận Long Biên')
INSERT INTO HUYEN VALUES('1','10',N'Quận Bắc Từ Liêm')
INSERT INTO HUYEN VALUES('2','11',N'Quận 1')
INSERT INTO HUYEN VALUES('2','12',N'Quận 2')
INSERT INTO HUYEN VALUES('2','13',N'Quận 3')
INSERT INTO HUYEN VALUES('2','14',N'Quận 4')
INSERT INTO HUYEN VALUES('2','15',N'Quận 5')
INSERT INTO HUYEN VALUES('2','16',N'Quận 6')
INSERT INTO HUYEN VALUES('2','17',N'Quận 7')
INSERT INTO HUYEN VALUES('2','18',N'Quận 8')
INSERT INTO HUYEN VALUES('2','19',N'Quận 9')
INSERT INTO HUYEN VALUES('2','20',N'Quận 10')
INSERT INTO HUYEN VALUES('3','21',N'Quận Hải Châu')
INSERT INTO HUYEN VALUES('3','22',N'Quận Thanh Khê')
INSERT INTO HUYEN VALUES('3','23',N'Quận Sơn Trà')
INSERT INTO HUYEN VALUES('3','24',N'Quận Ngũ Hành Sơn')
INSERT INTO HUYEN VALUES('3','25',N'Quận Liên Chiểu')
INSERT INTO HUYEN VALUES('3','26',N'Quận Hòa Vang')
INSERT INTO HUYEN VALUES('3','27',N'Quận Cẩm Lệ')
GO

--Sắp xếp dữ liệu huyện
SELECT * FROM HUYEN
ORDER BY MATINH ASC, MAHUYEN ASC
GO

--Dữ liệu dân tộc
INSERT INTO DANTOC VALUES('1',N'Kinh')
INSERT INTO DANTOC VALUES('2',N'Tày')
INSERT INTO DANTOC VALUES('3',N'Thái')
INSERT INTO DANTOC VALUES('4',N'Hoa')
INSERT INTO DANTOC VALUES('5',N'Khơ me')
INSERT INTO DANTOC VALUES('6',N'Mường')
INSERT INTO DANTOC VALUES('7',N'Nùng')
INSERT INTO DANTOC VALUES('8',N'HMông')
INSERT INTO DANTOC VALUES('9',N'Dao')
INSERT INTO DANTOC VALUES('10',N'Gia-rai')
GO

--Dữ liệu tôn giáo
INSERT INTO TONGIAO VALUES('1',N'Phật giáo')
INSERT INTO TONGIAO VALUES('2',N'Công giáo')
INSERT INTO TONGIAO VALUES('3',N'Tin lành')
INSERT INTO TONGIAO VALUES('4',N'Cao Đài')
INSERT INTO TONGIAO VALUES('5',N'Phật giáo Hòa Hảo')
INSERT INTO TONGIAO VALUES('6',N'Hồi giáo')
GO

--Dữ liệu hạng GPLX
INSERT INTO HANGGPLX VALUES('A1',N'Mô tô 2 bánh(50-175cm3)')
INSERT INTO HANGGPLX VALUES('A2',N'Mô tô 2 bánh(175cm3)')
INSERT INTO HANGGPLX VALUES('A3',N'Mô tô 3 bánh')
INSERT INTO HANGGPLX VALUES('A4',N'Máy kéo có tải trọng dưới 1000kg')
INSERT INTO HANGGPLX VALUES('B1',N'Ô tô cấp cho người không hành nghề lái xe')
INSERT INTO HANGGPLX VALUES('B2',N'Ô tô cấp cho người hành nghề lái xe')
INSERT INTO HANGGPLX VALUES('C',N'Ô tô, ô tô tải có tải trọng từ 3500kg')
INSERT INTO HANGGPLX VALUES('D',N'Ô tô chở người từ 10-30 chỗ')
INSERT INTO HANGGPLX VALUES('E',N'Ô tô chở người trên 30 chỗ')
INSERT INTO HANGGPLX VALUES('F',N'Rơ mooc')
GO

--Dữ liệu cơ sở đào tạo
INSERT INTO CSDAOTAO VALUES('01',N'TT Đào tạo lái xe Long Biên')
INSERT INTO CSDAOTAO VALUES('02',N'Trường Trung cấp nghề số 18')
INSERT INTO CSDAOTAO VALUES('03',N'TT Đào tạo và Kỹ thuật Ô tô')
INSERT INTO CSDAOTAO VALUES('04',N'Trường Công nhân Kỹ thuật Củ Chi')
INSERT INTO CSDAOTAO VALUES('05',N'Trường Trung cấp nghề Nhân Đạo')
INSERT INTO CSDAOTAO VALUES('06',N'Trường Trung cấp nghề số 7')
INSERT INTO CSDAOTAO VALUES('07',N'TT đào tạo lái xe Đà Nẵng STC.')
INSERT INTO CSDAOTAO VALUES('08',N'TT dạy nghề lái xe ô tô – mô tô MASCO')
INSERT INTO CSDAOTAO VALUES('09',N'TT đào tạo lái xe Khuê Mỹ')
GO

--Dữ liệu lý lịch
SET DATEFORMAT DMY
INSERT INTO LYLICH VALUES('1',N'Phạm Minh',N'Hiếu','11/11/2002','Nam','100000010','3',N'01 Phạm Văn Đồng','21','0390782253','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('2',N'Phan Thanh',N'Tùng','27/09/2002','Nam','100000011','1',N'01 Trần Hưng Đạo','9','0763427891','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('3',N'Cao Hoài',N'Bão','11/05/1997','Nam','100000012','2',N'421 Võ Nguyên Giáp','11','0570370794','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('4',N'Ngô Thế',N'Hùng','17/04/1999','Nam','100000013','3',N'466 Cầu Diễn','27','0953019942','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('5',N'Trần Thị Mỹ',N'Linh','13/08/2002',N'Nữ','100000014','2',N'01 Phạm Văn Đồng','15','0987654216','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('6',N'Huỳnh Trần Nhật',N'Phi','22/7/1996','Nam','100000015','2',N'21 Xô Viết Nghệ Tĩnh','17','0978441512','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('7',N'Trần Văn',N'Bảo','11/03/1994','Nam','100000016','2',N'366 Phan Văn Trị','11','0785125785','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('8',N'Phạm Trần Vân',N'Anh','11/11/2002',N'Nữ','100000017','1',N'81 Nguyễn Bỉnh Khiêm','7','0785558888','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('9',N'Nguyễn Đình',N'Văn','07/01/2002','Nam','100000018','1',N'249 Lý Thường Kiệt','6','0784326846','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('10',N'Võ Thị Anh',N'Trà','01/08/2002',N'Nữ','100000019','1',N'450 Ngô Quyền','5','0983572468','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('11',N'Đinh Hữu Vĩnh',N'Châu','07/05/2002','Nam','100000020','3',N'45 Lê Văn Việt','25','0595537547','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('12',N'Mai Thị Thu',N'Quyên','25/12/2003',N'Nữ','100000021','2',N'152 Xa Lộ Hà Nội','13','0137534567','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('13',N'Nguyễn Phước Tự',N'Tin','01/03/1997','Nam','100000022','1',N'1021 Điện Biên Phủ','4','0462464367','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('14',N'Nguyễn Thị Thu',N'Phương','20/05/1995',N'Nữ','100000023','2',N'252 Trường Chinh','18','0468467575','1','1',N'Việt Nam',NULL)
INSERT INTO LYLICH VALUES('15',N'Lê Minh',N'Anh','12/03/1993',N'Nữ','100000024','1',N'121 Tôn Thất Thuyết','1','0785357567','1','1',N'Việt Nam',NULL)
GO

--Dữ liệu GPLX
SET DATEFORMAT DMY
INSERT INTO HOSOGPLX VALUES('100000010','1','1/1/2020','1/1/2030','A2','05','90','95')
INSERT INTO HOSOGPLX VALUES('100000011','2','1/1/2019','1/1/2029','A1','01','90','95')
INSERT INTO HOSOGPLX VALUES('100000012','3','1/1/2019','1/1/2026','B1','01','90','98')
INSERT INTO HOSOGPLX VALUES('100000013','4','1/1/2021','1/1/2031','A1','03','90','95')
INSERT INTO HOSOGPLX VALUES('100000014','5','1/1/2020','1/1/2030','A1','01','90','90')
INSERT INTO HOSOGPLX VALUES('100000015','6','1/1/2019','1/1/2026','C','02','95','90')
INSERT INTO HOSOGPLX VALUES('100000016','7','1/1/2019','1/1/2024','D','04','90','95')
INSERT INTO HOSOGPLX VALUES('100000017','8','1/1/2021','1/1/2031','A2','07','90','95')
INSERT INTO HOSOGPLX VALUES('100000018','9','1/1/2019','1/1/2029','A2','09','90','95')
INSERT INTO HOSOGPLX VALUES('100000019','10','1/1/2019','1/1/2029','A1','02','90','95')
INSERT INTO HOSOGPLX VALUES('100000020','11','1/1/2019','1/1/2029','A1','01','90','95')
INSERT INTO HOSOGPLX VALUES('100000021','12','1/1/2021','1/1/2031','A2','01','90','95')
INSERT INTO HOSOGPLX VALUES('100000022','13','1/1/2020','1/1/2025','D','08','90','95')
INSERT INTO HOSOGPLX VALUES('100000023','14','1/1/2017','1/1/2022','D','06','90','95')
INSERT INTO HOSOGPLX VALUES('100000024','15','1/1/2016','1/1/2021','F','04','90','95')
GO

--Dữ liệu tạm giữ gplx
INSERT INTO TAMGIUGPLX VALUES('1','100000011',N'Sử dụng rượu bia khi tham gia giao thông','11/3/2021','11/7/2021',NULL)
INSERT INTO TAMGIUGPLX VALUES('2','100000019',N'Không chấp hành hiệu lệnh khi tham gia giao thông','25/5/2021','25/9/2021',NULL)
INSERT INTO TAMGIUGPLX VALUES('3','100000022',N'Vi phạm tốc độ','25/3/2021','25/9/2021',NULL)

--Tạo view lý lịch
CREATE VIEW view_LYLICH([Số lý lịch],[Họ và tên],[CMND],[Ngày sinh],[Giới tính],[Địa chỉ thường trú],[Quân(Huyện)],[Thành phố(Tỉnh)],[Số điện thoại],[Dân tộc],[Tôn giáo],[Quốc tịch])
AS 
	SELECT SOLYLICH, HOLOT+' '+TEN, CMND, CONVERT(VARCHAR(11),NGAYSINH,103), GIOITINH, DIACHITT, TENHUYEN, TENTINH, SDT, TENDT, TENTG, QUOCTICH
	FROM LYLICH L, TINH T, HUYEN H, TONGIAO TG, DANTOC DT
	WHERE L.MATINH = T.MATINH AND L.MAHUYEN = H.MAHUYEN AND L.MATG = TG.MATG AND L.MADT = DT.MADT
	GROUP BY SOLYLICH, HOLOT, TEN, CMND, NGAYSINH, GIOITINH, DIACHITT, TENHUYEN, TENTINH, SDT, TENDT, TENTG, QUOCTICH
GO
SELECT * FROM view_LYLICH
GO

--Tạo view hồ sơ giấy phép lái xe
CREATE VIEW view_HSGPLX([Họ và tên],[Serial],[Số lý lịch],[Ngày cấp],[Ngày hết hạn],[Mã hạng],[Mã cơ sở đào tạo],[Tên cơ sở đào tạo],[Điểm lý thuyết],[Điểm thực hành])
AS
	SELECT L.HOLOT+' '+L.TEN, HS.SERIAL, HS.SOLYLICH, CONVERT(VARCHAR(11),HS.NGAYCAP,103), CONVERT(VARCHAR(11),HS.THOIHAN,103), HS.MAHANG, HS.MACSDT, CS.TENCSDT, HS.DIEMLT, HS.DIEMTH
	FROM HOSOGPLX HS , LYLICH L, CSDAOTAO CS
	WHERE L.SOLYLICH = HS.SOLYLICH AND CS.MACSDT = HS.MACSDT
GO
SELECT * FROM view_HSGPLX
GO

--Tạo view tạm giữ giấy phép lái xe
CREATE VIEW view_TAMGIU([Số thứ tự],[Họ và tên],[CMND],[Serial],[Lí do thu bằng],[Thời gian thu],[Thời gian trả],[Ghi chú])
AS
	SELECT SOTHUTU, L.HOLOT+' '+L.TEN, L.CMND, TG.SERIAL, TG.LIDO, CONVERT(VARCHAR(11),TG.THOIGIANTHU,103), CONVERT(VARCHAR(11),TG.THOIGIANTRA,103), TG.GHICHU 
	FROM TAMGIUGPLX TG, HOSOGPLX HS, LYLICH L
	WHERE TG.SERIAL = HS.SERIAL AND HS.SOLYLICH = L.SOLYLICH
GO
SELECT * FROM view_TAMGIU
GO

--Tạo stored procedure in danh sách lý lịch theo giới tính
CREATE PROC proc_LYLICH_GIOITINH @GIOITINH NVARCHAR(5)
AS
	SELECT SOLYLICH [Số lý lịch], HOLOT+' '+TEN [Họ và tên], CMND, CONVERT(VARCHAR(11),NGAYSINH,103) [Ngày sinh], GIOITINH [Giới tính], DIACHITT [Địa chỉ thường trú], TENHUYEN [Quận(Huyện)], TENTINH [Thành phố(Tỉnh)], SDT [Số điện thoại], TENDT [Dân tộc], TENTG [Tôn giáo], QUOCTICH [Quốc tịch]
	FROM LYLICH L, TINH T, HUYEN H, TONGIAO TG, DANTOC DT
	WHERE L.MATINH = T.MATINH AND L.MAHUYEN = H.MAHUYEN AND L.MATG = TG.MATG AND L.MADT = DT.MADT AND GIOITINH LIKE @GIOITINH
	ORDER BY CMND ASC
GO
EXEC proc_LYLICH_GIOITINH 'Nam'
EXEC proc_LYLICH_GIOITINH N'Nữ'
GO

-- Tạo stored procedure in danh sách gplx theo mã hạng
CREATE PROC proc_HSGPLX (@MAHANG NCHAR(2))
AS
	SELECT L.HOLOT+' '+L.TEN [Họ và tên], HS.SERIAL [Serial], CONVERT(VARCHAR(11),HS.NGAYCAP,103) [Ngày cấp], CONVERT(VARCHAR(11),HS.THOIHAN,103) [Ngày hết hạn], HS.MAHANG [Mã hạng], HS.MACSDT [Mã cơ sở đào tạo], CS.TENCSDT [Tên cơ sở đào tạo]
	FROM HOSOGPLX HS , LYLICH L, CSDAOTAO CS
	WHERE L.SOLYLICH = HS.SOLYLICH AND CS.MACSDT = HS.MACSDT AND HS.MAHANG = @MAHANG
GO
EXEC proc_HSGPLX 'D'
GO 

--Tạo stored procedure	in danh sách gplx hết hạn
CREATE PROC proc_GPLXHETHAN(@THOIGIAN DATE)
AS
	SELECT SERIAL AS [Serial], HOLOT+' '+TEN AS [Họ và tên], CONVERT(VARCHAR(11),HS.NGAYCAP,103) AS [Ngày cấp], CONVERT(VARCHAR(11),HS.THOIHAN,103) AS [Ngày hết hạn], MAHANG AS [Mã hạng]
	FROM HOSOGPLX HS, LYLICH L
	WHERE HS.SOLYLICH = L.SOLYLICH AND HS.THOIHAN < @THOIGIAN
GO
SET DATEFORMAT DMY
EXEC proc_GPLXHETHAN '26/8/2021'

-- TẠO HÀM TÍNH TUỔI 

CREATE FUNCTION func_age(@age DATE )
RETURNS INT
AS
BEGIN
    RETURN YEAR(GETDATE()) - YEAR(@age)
END 
GO

--Sử dụng hàm tính tuổi để xuất ra lý lịch của những người lớn hơn 20 tuổi
SELECT [AGE]=dbo.func_age(NGAYSINH), SOLYLICH [Số lý lịch], HOLOT+' '+TEN [Họ và tên], CONVERT(VARCHAR(11),NGAYSINH,103) [Ngày sinh], GIOITINH [Giới tính], SDT [Số điện thoại]  
FROM dbo.LYLICH WHERE dbo.func_age(NGAYSINH)  > 20
GO
-- Tạo Trigger khi mà muốn thay đổi dữ liệu thì không cho phép
CREATE TRIGGER trigger_add 
ON dbo.TINH
FOR INSERT
AS
    BEGIN
        RAISERROR(N'=====ACCESS DENIED=====',16,1)
        ROLLBACK TRAN
    END
GO

--Gọi,Thêm và Xóa dữ liệu để test
SELECT * From dbo.TINH
INSERT TINH VALUES (4,N'Điện Biên')
INSERT TINH VALUES (5,N'Hải Phòng')
DELETE FROM TINH Where MATINH >3

