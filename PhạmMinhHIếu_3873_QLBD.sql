/*
Họ và tên: Phạm Minh Hiếu
MSSV: 2011063873
Lớp: 20DTHB4
*/

-- Tạo database 
CREATE DATABASE QLBD
ON
	(NAME='QLBD_DATA',
	FILENAME='H:\BAITAP\QLBD.MDF')
LOG ON
	(NAME='QLBD_LOG',
	FILENAME='H:\BAITAP\QLBD.LDF')
GO

USE QLBD
GO

--Tạo bảng sân
CREATE TABLE SAN
(
	MASAN CHAR(3),
	TENSAN NVARCHAR(30),
	DIACHI NVARCHAR(50),

	CONSTRAINT PK_SAN_MASAN PRIMARY KEY (MASAN)
)
GO

CREATE TABLE DOI
(
	MADOI CHAR(4),
	TENDOI NVARCHAR(20),
	MASAN CHAR(3),

	CONSTRAINT PK_DOI_MADOI PRIMARY KEY (MADOI),
)
GO

CREATE TABLE TRANDAU
(
	MATD CHAR(2),
	MASAN CHAR(3),
	NGAY DATE,
	GIO TIME,

	CONSTRAINT PK_TRANDAU_MATD PRIMARY KEY (MATD),

	CONSTRAINT FK_TRANDAU_MASAN FOREIGN KEY (MASAN) REFERENCES SAN(MASAN)
	ON UPDATE CASCADE
	ON DELETE CASCADE	
)
GO

CREATE TABLE CT_TRANDAU
(
	MATD CHAR(2),
	MADOI CHAR(4),
	SOBANTHANG TINYINT CHECK(SOBANTHANG >=0)

	CONSTRAINT PK_CTTD_MATD_MADOI PRIMARY KEY (MATD,MADOI),
	
	CONSTRAINT FK_CTTD_MATD FOREIGN KEY (MATD) REFERENCES TRANDAU(MATD)
	ON DELETE NO ACTION 
	ON UPDATE NO ACTION,

	CONSTRAINT FK_CTTD_MADOI FOREIGN KEY (MADOI) REFERENCES DOI(MADOI)
	ON DELETE NO ACTION 
	ON UPDATE NO ACTION,
)
GO

--Thêm dữ liệu bảng sân
INSERT INTO SAN VALUES ('MDI', N'Mỹ Đình', N'Hà Nội - Việt Nam')
INSERT INTO SAN VALUES ('NAS', N'Sân vận động quốc gia', N'Viêng Chăn - Lào')
INSERT INTO SAN VALUES ('IMO', N'Sân I-Mobile', N'Buriam - Thái Lan')
INSERT INTO SAN VALUES ('MOD', N'Khu thể thao Morodok Decho', N'Russey Keo - Campuchia')
GO

--Thêm dữ liệu bảng đội
INSERT INTO DOI VALUES ('VN', N'Việt Nam', NULL)
INSERT INTO DOI VALUES ('LA', N'Lào', NULL)
INSERT INTO DOI VALUES ('TL', N'Thái Lan', NULL)
INSERT INTO DOI VALUES ('CPC', N'Campuchia', NULL)
GO

--Thêm dữ liệu bảng trận đấu
SET DATEFORMAT DMY
INSERT INTO TRANDAU VALUES ('1', 'MOD', '14/08/2017', '15:00')
INSERT INTO TRANDAU VALUES ('2', 'NAS', '16/08/2017', '17:00')
INSERT INTO TRANDAU VALUES ('3', 'MOD', '16/08/2017', '15:00')
INSERT INTO TRANDAU VALUES ('4', 'IMO', '18/08/2017', '19:00')
GO

--Thêm dữ liệu bảng chi tiết trận đấu
INSERT INTO CT_TRANDAU VALUES ('1', 'VN', '3')
INSERT INTO CT_TRANDAU VALUES ('1', 'TL', '1')
INSERT INTO CT_TRANDAU VALUES ('2', 'VN', '5')
INSERT INTO CT_TRANDAU VALUES ('2', 'LA', '0')
INSERT INTO CT_TRANDAU VALUES ('3', 'TL', '3')
INSERT INTO CT_TRANDAU VALUES ('3', 'CPC', '3')
INSERT INTO CT_TRANDAU VALUES ('4', 'TL', '2')
INSERT INTO CT_TRANDAU VALUES ('4', 'LA', '0')
GO

--Câu 1
SELECT D.MADOI [Mã đội], TENDOI [Tên đội], COUNT(D.MADOI) [Số trận đấu]
FROM DOI D, CT_TRANDAU CT
WHERE D.MADOI = CT.MADOI
GROUP BY D.MADOI, TENDOI
GO

--Câu 2
SELECT CT.MATD [Mã trận], CT.MADOI + ' - ' + CT1.MADOI [Đội trận đấu], STR(CT.SOBANTHANG, 2) + ' - ' + STR(CT1.SOBANTHANG, 2) [Tỉ số]
FROM CT_TRANDAU CT, CT_TRANDAU CT1
WHERE CT.MATD = CT1.MATD AND CT.MADOI > CT1.MADOI
GO

--Câu 3
SELECT CT.MATD[Mã trận] ,D.MADOI[Mã đội], D.TENDOI[Tên đội], 'Điểm' =SUM(CASE
													WHEN CAST(CT.SOBANTHANG AS INT) > CAST(CT1.SOBANTHANG AS INT) THEN 3
													WHEN CAST(CT.SOBANTHANG AS INT) < CAST(CT1.SOBANTHANG AS INT) THEN 0
													ELSE 1
													END)
FROM DOI D, CT_TRANDAU CT, CT_TRANDAU CT1
WHERE D.MADOI = CT.MADOI AND CT.MATD = CT1.MATD AND CT.MADOI <> CT1.MADOI
GROUP BY D.MADOI, D.TENDOI, CT.MATD
ORDER BY CT.MATD ASC

--Câu 4
SELECT D.MADOI[Mã đội], D.TENDOI[Tên đội], 'Tổng số điểm' = SUM(CASE
													WHEN CAST(CT.SOBANTHANG AS INT) > CAST(CT1.SOBANTHANG AS INT) THEN 3
													WHEN CAST(CT.SOBANTHANG AS INT) < CAST(CT1.SOBANTHANG AS INT) THEN 0
													ELSE 1
													END)
FROM DOI D, CT_TRANDAU CT, CT_TRANDAU CT1
WHERE D.MADOI = CT.MADOI AND CT.MATD = CT1.MATD AND CT.MADOI <> CT1.MADOI
GROUP BY D.MADOI, D.TENDOI
ORDER BY [Tổng số điểm] DESC
GO

--Câu 5
SELECT D.MADOI[Mã đội], D.TENDOI[Tên đội], 'Tổng số điểm' = SUM(CASE
													WHEN CAST(CT.SOBANTHANG AS INT) > CAST(CT1.SOBANTHANG AS INT) THEN 3
													WHEN CAST(CT.SOBANTHANG AS INT) < CAST(CT1.SOBANTHANG AS INT) THEN 0
													ELSE 1
													END),
							'Hiệu số' = SUM(CAST(CT.SOBANTHANG AS INT)-CAST(CT1.SOBANTHANG AS INT))
FROM DOI D, CT_TRANDAU CT, CT_TRANDAU CT1
WHERE D.MADOI = CT.MADOI AND CT.MATD = CT1.MATD AND CT.MADOI <> CT1.MADOI
GROUP BY D.MADOI, D.TENDOI
ORDER BY [Tổng số điểm] DESC